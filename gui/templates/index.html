<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #1a1a1a; --panel: #2d2d2d; --text: #e0e0e0; --accent: #3498db; --success: #2ecc71; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: var(--panel); padding: 20px; display: flex; flex-direction: column; gap: 15px; border-right: 1px solid #444; }
        .logo { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; color: var(--accent); }
        button { background: var(--accent); color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.red { background: #e74c3c; }
        select { padding: 8px; background: #444; color: white; border: 1px solid #555; border-radius: 4px; }
        
        .pin-list { overflow-y: auto; flex: 1; border: 1px solid #444; padding: 10px; border-radius: 4px; }
        .pin-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        
        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 20px; overflow: hidden; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .tab { padding: 8px 16px; cursor: pointer; border-radius: 4px; background: #333; }
        .tab.active { background: var(--accent); }
        
        /* Views */
        .view { display: none; flex: 1; overflow: hidden; flex-direction: column; }
        .view.active { display: flex; }
        
        /* Monitor */
        .monitor-log { flex: 1; background: #000; font-family: monospace; padding: 10px; overflow-y: auto; border-radius: 4px; margin-bottom: 10px; }
        .log-entry { margin: 2px 0; border-bottom: 1px solid #222; display: flex; gap: 10px; }
        .log-time { color: #888; min-width: 80px; }
        .log-origin { color: var(--accent); min-width: 100px; font-weight: bold; }
        .input-area { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; }
        
        /* Pins */
        .pin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; padding: 20px; }
        .pin-card { background: #333; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #444; }
        .pin-card.active { border-color: var(--success); }
        .pin-val { font-size: 1.2em; font-weight: bold; margin-top: 5px; }
        .led { width: 15px; height: 15px; border-radius: 50%; background: #555; margin: 5px auto; }
        .led.on { background: var(--success); box-shadow: 0 0 10px var(--success); }
        
        /* Graph */
        .chart-container { flex: 1; position: relative; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">Arduino GUI</div>
        
        <select id="port-select"><option>Loading ports...</option></select>
        <button onclick="refreshPorts()">Refresh Ports</button>
        <button id="connect-btn" onclick="toggleConnect()">Connect</button>
        
        <div style="margin-top: 20px; font-weight: bold;">Pin Config</div>
        <button onclick="detectAll()">Detect All</button>
        <div class="pin-list" id="pin-config-list">
            <!-- Checkboxes generated here -->
        </div>
        <button onclick="applyConfig()">Apply Config</button>
    </div>

    <div class="main">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('monitor')">Monitor</div>
            <div class="tab" onclick="switchTab('pins')">Pins</div>
            <div class="tab" onclick="switchTab('graph')">Graph</div>
        </div>

        <!-- Monitor View -->
        <div id="monitor" class="view active">
            <div class="monitor-log" id="log-container"></div>
            <div class="input-area">
                <input type="text" id="cmd-input" placeholder="Send command..." onkeypress="if(event.key==='Enter') sendCmd()">
                <button onclick="sendCmd()">Send</button>
            </div>
        </div>

        <!-- Pins View -->
        <div id="pins" class="view">
            <div class="pin-grid" id="pin-visualizer"></div>
        </div>

        <!-- Graph View -->
        <div id="graph" class="view">
            <div class="chart-container">
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let isConnected = false;
        let chart;
        let chartData = {}; // { 'A0': [v1, v2...], ... }
        
        // --- Init ---
        window.onload = () => {
            refreshPorts();
            initPinConfig();
            initChart();
        };

        // --- Socket Events ---
        socket.on('new_message', (msg) => {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span class="log-time">${msg.timestamp}</span><span class="log-origin">${msg.origin}</span><span>${msg.data}</span>`;
            const container = document.getElementById('log-container');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        });

        socket.on('status_update', (status) => {
            updatePinVisualizer(status);
            updateGraph(status);
        });

        socket.on('log_message', (msg) => {
            console.log("Server Log:", msg.data);
        });

        // --- Functions ---
        async function refreshPorts() {
            const res = await fetch('/api/ports');
            const data = await res.json();
            const sel = document.getElementById('port-select');
            sel.innerHTML = '';
            data.ports.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.text = p;
                sel.appendChild(opt);
            });
        }

        async function toggleConnect() {
            const btn = document.getElementById('connect-btn');
            if (!isConnected) {
                const port = document.getElementById('port-select').value;
                const res = await fetch('/api/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({port})
                });
                if (res.ok) {
                    isConnected = true;
                    btn.textContent = "Disconnect";
                    btn.classList.add('red');
                }
            } else {
                await fetch('/api/disconnect', {method: 'POST'});
                isConnected = false;
                btn.textContent = "Connect";
                btn.classList.remove('red');
            }
        }

        async function sendCmd() {
            const input = document.getElementById('cmd-input');
            const cmd = input.value;
            if (cmd) {
                await fetch('/api/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({cmd})
                });
                input.value = '';
            }
        }

        // --- Pin Config ---
        function initPinConfig() {
            const list = document.getElementById('pin-config-list');
            // Digital
            for(let i=0; i<14; i++) {
                list.innerHTML += `<div class="pin-item"><input type="checkbox" id="chk-d${i}" data-type="D" data-idx="${i}"><label>D${i}</label></div>`;
            }
            // Analog
            for(let i=0; i<6; i++) {
                list.innerHTML += `<div class="pin-item"><input type="checkbox" id="chk-a${i}" data-type="A" data-idx="${i}"><label>A${i}</label></div>`;
            }
        }

        function detectAll() {
            document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = true);
            applyConfig();
        }

        async function applyConfig() {
            const d_pins = [];
            const a_pins = [];
            document.querySelectorAll('input[type="checkbox"]').forEach(c => {
                if (c.checked) {
                    if (c.dataset.type === 'D') d_pins.push(parseInt(c.dataset.idx));
                    else a_pins.push(parseInt(c.dataset.idx));
                }
            });
            
            await fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({d_pins, a_pins})
            });
            
            // Reset Visualizer
            document.getElementById('pin-visualizer').innerHTML = '';
            d_pins.forEach(p => createPinCard(`D${p}`, 'D'));
            a_pins.forEach(p => createPinCard(`A${p}`, 'A'));
            
            // Reset Chart
            chartData = {};
            a_pins.forEach(p => chartData[`A${p}`] = []);
            chart.data.datasets = a_pins.map(p => ({
                label: `A${p}`,
                data: [],
                borderColor: getRandomColor(),
                fill: false
            }));
            chart.update();
        }

        function createPinCard(id, type) {
            const div = document.createElement('div');
            div.className = 'pin-card';
            div.id = `card-${id}`;
            div.innerHTML = `
                <div>${id}</div>
                ${type === 'D' ? '<div class="led" id="val-'+id+'"></div>' : '<div class="pin-val" id="val-'+id+'">0</div>'}
            `;
            document.getElementById('pin-visualizer').appendChild(div);
        }

        function updatePinVisualizer(status) {
            for (const [key, val] of Object.entries(status)) {
                const el = document.getElementById(`val-${key}`);
                if (el) {
                    if (key.startsWith('D')) {
                        if (val === 1) el.classList.add('on');
                        else el.classList.remove('on');
                    } else {
                        el.textContent = val;
                    }
                }
            }
        }

        // --- Graph ---
        function initChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: Array(50).fill(''), datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: { y: { beginAtZero: true, max: 1024 } }
                }
            });
        }

        function updateGraph(status) {
            let updated = false;
            for (const [key, val] of Object.entries(status)) {
                if (key.startsWith('A') && chartData[key]) {
                    chartData[key].push(val);
                    if (chartData[key].length > 50) chartData[key].shift();
                    
                    // Find dataset
                    const ds = chart.data.datasets.find(d => d.label === key);
                    if (ds) {
                        ds.data = chartData[key];
                        updated = true;
                    }
                }
            }
            if (updated) chart.update();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
    </script>
</body>
</html>
